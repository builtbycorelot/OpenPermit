{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openpermit.io/schema/integrated-consortium",
  "title": "OpenPermit Integrated Natural-Built-Digital Data Model",
  "description": "Unified schema aligning NIEM, BLDS, OGC/GeoJSON, IFC/openBIM, CityJSON, ISO 37120, and EPA permitting data standards to support automated permitting and emergency response workflows across a statewide consortium.",
  "type": "object",
  "required": [
    "metadata",
    "project",
    "spatialContext",
    "builtAssets",
    "iotSystems",
    "workflows",
    "apiInterfaces"
  ],
  "properties": {
    "metadata": {
      "type": "object",
      "required": ["schemaVersion", "standardReferences", "provenance"],
      "properties": {
        "schemaVersion": {
          "type": "string",
          "description": "Semantic version of the integrated schema."
        },
        "standardReferences": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "Identifier or citation for NIEM, OGC, ISO, EPA, IFC, or BLDS standards referenced by this payload."
          },
          "minItems": 1
        },
        "provenance": {
          "$ref": "#/$defs/provenanceRecord"
        }
      }
    },
    "project": {
      "type": "object",
      "required": ["projectId", "name", "jurisdiction", "consortiumMember"],
      "properties": {
        "projectId": {
          "type": "string",
          "description": "Globally unique identifier aligning with NIEM ID/Reference model."
        },
        "name": {
          "type": "string",
          "description": "Human readable project or permit name."
        },
        "jurisdiction": {
          "$ref": "#/$defs/jurisdiction"
        },
        "consortiumMember": {
          "type": "object",
          "required": ["agencyName", "role"],
          "properties": {
            "agencyName": {
              "type": "string",
              "description": "Participating agency, utility, or institution."
            },
            "role": {
              "type": "string",
              "enum": [
                "Applicant",
                "BuildingDepartment",
                "FireMarshal",
                "EnvironmentalAgency",
                "TransportationAgency",
                "Utility",
                "AcademicPartner",
                "EmergencyManagement"
              ]
            }
          }
        },
        "program": {
          "type": "string",
          "description": "Strategic program or initiative that sponsors the project (e.g., resilience corridor, housing accelerator)."
        },
        "lifecyclePhase": {
          "type": "string",
          "enum": ["Planning", "Design", "Construction", "Operations", "EmergencyResponse", "Recovery"]
        }
      }
    },
    "spatialContext": {
      "type": "object",
      "description": "GIS features and natural environment context compliant with OGC/GeoJSON and ISO 37120 indicators.",
      "required": ["geojson", "elevationReference", "environmentalLayers"],
      "properties": {
        "geojson": {
          "$ref": "#/$defs/geoFeatureCollection"
        },
        "elevationReference": {
          "type": "string",
          "description": "Vertical datum reference (e.g., NAVD88) per OGC/USGS standards."
        },
        "environmentalLayers": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/environmentalLayer"
          }
        }
      }
    },
    "builtAssets": {
      "type": "object",
      "description": "Built environment models linking IFC/openBIM, CityJSON, and PDF/E deliverables.",
      "required": ["bimModels", "documentLinks"],
      "properties": {
        "bimModels": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/bimModel"
          },
          "minItems": 1
        },
        "documentLinks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["uri", "format"],
            "properties": {
              "uri": {
                "type": "string",
                "format": "uri",
                "description": "Link to supporting PDF/A-3, PDF/E, or OPC-compliant package."
              },
              "format": {
                "type": "string",
                "enum": ["PDF/A-3", "PDF/E", "OPC", "BPMN", "Other"]
              },
              "description": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "iotSystems": {
      "type": "array",
      "description": "Sensors and digital environment feeds providing real-time telemetry.",
      "items": {
        "$ref": "#/$defs/iotSensor"
      }
    },
    "workflows": {
      "type": "object",
      "required": ["permitApplications", "emergencyAssessments"],
      "properties": {
        "permitApplications": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/permitApplication"
          }
        },
        "emergencyAssessments": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/emergencyAssessment"
          }
        },
        "automations": {
          "type": "array",
          "description": "Automated workflows referencing BPMN processes or rule engines.",
          "items": {
            "$ref": "#/$defs/automation"
          }
        }
      }
    },
    "apiInterfaces": {
      "type": "array",
      "description": "Interfaces that expose this data via NIEM conformant exchanges, OData services, or event streams for interagency operations.",
      "items": {
        "$ref": "#/$defs/apiInterface"
      }
    }
  },
  "$defs": {
    "provenanceRecord": {
      "type": "object",
      "required": ["createdBy", "createdOn"],
      "properties": {
        "createdBy": {
          "type": "string",
          "description": "Organization or user ID responsible for the payload."
        },
        "createdOn": {
          "type": "string",
          "format": "date-time"
        },
        "lastModifiedOn": {
          "type": "string",
          "format": "date-time"
        },
        "confidentiality": {
          "type": "string",
          "enum": ["Public", "ForOfficialUseOnly", "Sensitive", "Confidential"]
        }
      }
    },
    "jurisdiction": {
      "type": "object",
      "required": ["state", "county", "municipality"],
      "properties": {
        "state": {
          "type": "string",
          "description": "Two-letter state or territory code."
        },
        "county": {
          "type": "string"
        },
        "municipality": {
          "type": "string"
        },
        "censusTract": {
          "type": "string"
        },
        "fipsCode": {
          "type": "string",
          "pattern": "^\\d{5}$"
        }
      }
    },
    "geoFeatureCollection": {
      "type": "object",
      "required": ["type", "features"],
      "properties": {
        "type": {
          "const": "FeatureCollection"
        },
        "crs": {
          "type": "object",
          "description": "Coordinate reference system per OGC requirements.",
          "properties": {
            "type": {
              "type": "string"
            },
            "properties": {
              "type": "object"
            }
          }
        },
        "features": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/geoFeature"
          }
        }
      }
    },
    "geoFeature": {
      "type": "object",
      "required": ["type", "geometry", "properties"],
      "properties": {
        "type": {
          "const": "Feature"
        },
        "geometry": {
          "type": "object",
          "required": ["type", "coordinates"],
          "properties": {
            "type": {
              "type": "string",
              "enum": [
                "Point",
                "MultiPoint",
                "LineString",
                "MultiLineString",
                "Polygon",
                "MultiPolygon"
              ]
            },
            "coordinates": {
              "type": "array"
            }
          }
        },
        "properties": {
          "type": "object",
          "properties": {
            "parcelIdentifier": {
              "type": "string",
              "description": "BLDS compliant parcel ID."
            },
            "landUse": {
              "type": "string"
            },
            "hazardOverlay": {
              "type": "string",
              "description": "FEMA floodplain, wildfire risk, or other hazard classification."
            }
          }
        }
      }
    },
    "environmentalLayer": {
      "type": "object",
      "required": ["name", "source", "data"],
      "properties": {
        "name": {
          "type": "string"
        },
        "source": {
          "type": "string",
          "description": "Data provider or authoritative service (EPA, NOAA, USGS, etc.)."
        },
        "data": {
          "type": "object",
          "description": "Reference to raster, vector, or timeseries dataset."
        }
      }
    },
    "bimModel": {
      "type": "object",
      "required": ["modelId", "format", "uri"],
      "properties": {
        "modelId": {
          "type": "string"
        },
        "format": {
          "type": "string",
          "enum": ["IFC", "IFCJSON", "CityJSON", "LandXML", "InfraGML"]
        },
        "uri": {
          "type": "string",
          "format": "uri"
        },
        "discipline": {
          "type": "string",
          "enum": [
            "Architecture",
            "Structural",
            "MEP",
            "Civil",
            "Landscape",
            "FireProtection"
          ]
        },
        "version": {
          "type": "string"
        },
        "spatialReference": {
          "type": "string",
          "description": "EPSG code aligning BIM coordinates to GIS."
        }
      }
    },
    "iotSensor": {
      "type": "object",
      "required": ["sensorId", "type", "location", "measurements"],
      "properties": {
        "sensorId": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "AirQuality",
            "WaterLevel",
            "StructuralStrain",
            "EnergyMeter",
            "Traffic",
            "Weather",
            "Thermal",
            "Other"
          ]
        },
        "location": {
          "$ref": "#/$defs/geoFeature"
        },
        "measurements": {
          "type": "array",
          "description": "Latest observations aligned with NIEM Emergency Management and SensorThings concepts.",
          "items": {
            "type": "object",
            "required": ["timestamp", "value", "unit"],
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "value": {
                "type": "number"
              },
              "unit": {
                "type": "string"
              },
              "quality": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "permitApplication": {
      "type": "object",
      "required": ["applicationId", "status", "submittals"],
      "properties": {
        "applicationId": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": ["Draft", "Submitted", "InReview", "CorrectionsRequired", "Approved", "Denied"]
        },
        "submittals": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/submittal"
          }
        },
        "reviews": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/reviewRecord"
          }
        }
      }
    },
    "submittal": {
      "type": "object",
      "required": ["requirementId", "evidence"],
      "properties": {
        "requirementId": {
          "type": "string",
          "description": "Reference to NIEM RequirementNode or regulatory citation."
        },
        "evidence": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/evidence"
          }
        }
      }
    },
    "evidence": {
      "type": "object",
      "required": ["type", "reference"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["Document", "Model", "SensorSnapshot", "Photo", "Report"]
        },
        "reference": {
          "type": "string",
          "format": "uri"
        },
        "description": {
          "type": "string"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "reviewRecord": {
      "type": "object",
      "required": ["reviewer", "decision", "timestamp"],
      "properties": {
        "reviewer": {
          "type": "string",
          "description": "Agency role or reviewer identifier."
        },
        "decision": {
          "type": "string",
          "enum": ["Approved", "ConditionallyApproved", "CorrectionsRequired", "Rejected"]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "comments": {
          "type": "string"
        }
      }
    },
    "emergencyAssessment": {
      "type": "object",
      "required": ["eventId", "trigger", "existingConditions", "emergencyConditions", "actions"],
      "properties": {
        "eventId": {
          "type": "string"
        },
        "trigger": {
          "type": "string",
          "description": "Incident type or FEMA category triggering the assessment."
        },
        "existingConditions": {
          "type": "object",
          "description": "Snapshot of baseline conditions derived from BIM/GIS data."
        },
        "emergencyConditions": {
          "type": "object",
          "description": "Observed impacts with references to IoT sensor readings and damage assessments."
        },
        "actions": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["actionId", "priority", "status"],
            "properties": {
              "actionId": {
                "type": "string"
              },
              "priority": {
                "type": "string",
                "enum": ["LifeSafety", "Stabilization", "PropertyProtection", "EnvironmentalProtection"]
              },
              "status": {
                "type": "string",
                "enum": ["Planned", "InProgress", "Completed"]
              },
              "assignedTo": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "automation": {
      "type": "object",
      "required": ["id", "name", "standard"],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "standard": {
          "type": "string",
          "enum": ["BPMN", "DMN", "NIEM-IEPD", "Custom"]
        },
        "definition": {
          "type": "string",
          "description": "URI or embedded definition for the automation."
        }
      }
    },
    "apiInterface": {
      "type": "object",
      "required": ["interfaceId", "type", "protocol", "endpoints"],
      "properties": {
        "interfaceId": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["OData", "NIEM-JSON", "NIEM-XML", "REST", "MQTT", "Webhook"]
        },
        "protocol": {
          "type": "string",
          "enum": ["HTTPS", "AMQP", "MQTT", "SFTP"]
        },
        "description": {
          "type": "string",
          "description": "Purpose of the interface (permitting submission, emergency alerting, analytics feed)."
        },
        "endpoints": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["method", "path"],
            "properties": {
              "method": {
                "type": "string",
                "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "SUBSCRIBE"]
              },
              "path": {
                "type": "string"
              },
              "payload": {
                "type": "string",
                "description": "Reference to schema section used by this endpoint."
              },
              "security": {
                "type": "object",
                "properties": {
                  "authorization": {
                    "type": "string",
                    "enum": ["OAuth2", "MutualTLS", "APIKey", "OpenIDConnect"]
                  },
                  "nistControls": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "description": "Referenced NIST SP 800-53 control identifier."
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
