# OpenPermit Knowledge Packs

**Deterministic building code validation rules** for IFC model code checking.

## What Are Knowledge Packs?

Knowledge packs are **collections of deterministic validation rules** that encode building code requirements as executable code. They enable **permit-by-rule** through automated, objective code compliance checking.

### Key Principles

1. **Deterministic** â€” Same input, same output. No AI interpretation, no probabilistic reasoning.
2. **Testable** â€” Every rule includes test cases with known-good and known-bad examples.
3. **Versioned** â€” Semantic versioning tied to specific code editions (IRC 2021, IBC 2021, etc.).
4. **Open Source** â€” MIT licensed, forkable for local amendments.
5. **Auditable** â€” Validation logic is public, reviewable code.

### What They Are NOT

- âŒ **Not AI code interpreters** â€” Rules are written by human experts (code officials, engineers), not generated by LLMs
- âŒ **Not replacements for engineering** â€” Performance-based designs and complex systems still require PE review
- âŒ **Not discretionary** â€” Rules check objective requirements only (spacing, dimensions, quantities)

## Structure

```
knowledge-packs/
â”œâ”€â”€ IRC2021/
â”‚   â”œâ”€â”€ pack.json                 # Pack manifest (JSON-LD)
â”‚   â”œâ”€â”€ irc_r602_framing.py       # R602 Wall Framing rules
â”‚   â”œâ”€â”€ irc_r305_heights.py       # R305 Room Height rules
â”‚   â””â”€â”€ ...                       # Additional rule modules
â”œâ”€â”€ IBC2021/
â”‚   â”œâ”€â”€ pack.json
â”‚   â””â”€â”€ ...
â””â”€â”€ README.md (this file)
```

### Pack Manifest (`pack.json`)

JSON-LD format describing the knowledge pack:

```json
{
  "@context": "https://schema.openpermit.org/v1",
  "@type": "KnowledgePack",
  "id": "IRC2021",
  "code": "IRC2021",
  "version": "1.0.0",
  "rules": [
    {
      "id": "IRC-R602.3-stud-spacing",
      "codeReference": "IRC R602.3",
      "ruleType": "spacing",
      "checkFunction": "irc_r602_framing.py::check_stud_spacing",
      "applicability": {
        "elementType": "IfcWall",
        "conditions": {"isLoadBearing": true}
      },
      "parameters": {"maxSpacing": 16.0, "unit": "inches"},
      "testCases": [...]
    }
  ]
}
```

### Validation Rules (Python Modules)

Each rule is a **pure function** that:
- Takes IFC element data as input (dictionary)
- Returns `ValidationResult` (pass/fail/not_applicable)
- Includes docstring with code reference
- Has test cases for verification

**Example:**

```python
def check_stud_spacing(ifc_wall: Dict[str, Any]) -> ValidationResult:
    """
    IRC R602.3 - Validate stud spacing for load-bearing walls

    "Studs shall be spaced at not more than 16 inches (406 mm) on center
    for load-bearing walls supporting one floor, roof and ceiling."
    """
    if not ifc_wall.get("isLoadBearing"):
        return ValidationResult(result="not_applicable", ...)

    stud_spacing = ifc_wall.get("studSpacing")  # inches
    max_spacing = 16.0

    if stud_spacing <= max_spacing:
        return ValidationResult(result="pass", ...)
    else:
        return ValidationResult(result="fail", ...)
```

## Available Knowledge Packs

| Pack ID | Code Edition | Version | Rules | Status |
|---------|-------------|---------|-------|--------|
| `IRC2021` | IRC 2021 | 1.0.0 | 3 | âœ… Active |
| `IBC2021` | IBC 2021 | 0.1.0 | 0 | ðŸš§ In Development |
| `IECC2021` | IECC 2021 | 0.1.0 | 0 | ðŸš§ In Development |

## Usage

### Via API

**List available packs:**

```bash
GET /knowledge-packs?code=IRC2021
```

**Get pack rules:**

```bash
GET /knowledge-packs/IRC2021/rules
```

**Validate element:**

```bash
POST /knowledge-packs/validate-element
{
  "ifcElement": {
    "ifcGlobalId": "2O2Fr$t4X7Zf8NOew3FNr2",
    "isLoadBearing": true,
    "studSpacing": 16.0,
    "floorsSupported": 1
  },
  "ruleId": "IRC-R602.3-stud-spacing",
  "packId": "IRC2021"
}
```

**Response:**

```json
{
  "rule_id": "IRC-R602.3-stud-spacing",
  "code_reference": "IRC R602.3",
  "result": "pass",
  "message": "Stud spacing 16.0\" complies with IRC R602.3 maximum 16.0\" for single-floor load-bearing wall",
  "measured_value": 16.0,
  "required_value": "<= 16.0",
  "ifc_global_id": "2O2Fr$t4X7Zf8NOew3FNr2",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### Via MCP (AI Integration)

**Claude/ChatGPT can use the `validate_ifc_element` tool:**

> **User:** "Check if this wall meets IRC stud spacing requirements"
>
> **Claude:** [Uses `validate_ifc_element` MCP tool]
>
> "The wall passes IRC R602.3 validation. Stud spacing of 16\" complies with the maximum 16\" requirement for single-floor load-bearing walls."

### Direct Python Import

```python
from knowledge_packs.IRC2021.irc_r602_framing import check_stud_spacing

wall = {
    "ifcGlobalId": "2O2Fr$t4X7Zf8NOew3FNr2",
    "isLoadBearing": True,
    "studSpacing": 16.0,
    "floorsSupported": 1
}

result = check_stud_spacing(wall)
print(f"Result: {result.result}")  # "pass"
print(f"Message: {result.message}")
```

## Rule Types

Knowledge packs categorize rules by validation type:

| Rule Type | Description | Example |
|-----------|-------------|---------|
| **dimensional** | Measure geometry | Room sizes, ceiling heights |
| **spacing** | Check intervals | Stud spacing, joist spans |
| **material** | Verify specifications | Lumber grades, concrete strength |
| **quantity** | Count elements | Required outlets, smoke detectors |
| **clearance** | Measure distances | Fixture clearances, fire separation |
| **structural** | Check capacity | Load calculations (prescriptive tables) |

## IFC Element Mapping

Rules target specific IFC element types:

| IFC Element Type | Rule Examples |
|------------------|---------------|
| `IfcWall` | Stud spacing, fire rating, height limits |
| `IfcSlab` | Thickness, reinforcement, joist spans |
| `IfcSpace` | Room dimensions, ceiling heights, egress |
| `IfcWindow` | Egress area, height above floor |
| `IfcDoor` | Width, swing direction, fire rating |
| `IfcStair` | Rise, run, headroom, handrails |

## Jurisdiction-Specific Packs

Jurisdictions can **fork and extend** base packs for local amendments:

```
IRC2021-austin-tx/
  â”œâ”€â”€ pack.json              # Extends IRC2021 base
  â”œâ”€â”€ austin_amendments.py   # Local code amendments
  â””â”€â”€ ...
```

**Example local amendment:**

```json
{
  "@type": "KnowledgePack",
  "id": "IRC2021-austin-tx",
  "code": "IRC2021",
  "jurisdiction": "Austin, TX",
  "extends": "IRC2021",
  "rules": [
    {
      "id": "AUSTIN-WQ-impervious-cover",
      "codeReference": "Austin LDC 25-8-122",
      "description": "Impervious cover limits for Edwards Aquifer recharge zone",
      ...
    }
  ]
}
```

## Publishing to CKAN

Knowledge packs can be published as **open data** to CKAN portals:

```bash
POST /ckan/datasets
{
  "ckanUrl": "https://data.cityname.gov",
  "dataset": {
    "name": "irc2021-validation-rules",
    "title": "IRC 2021 Building Code Validation Rules",
    "description": "Deterministic validation rules for IRC 2021 prescriptive residential construction",
    "tags": ["building-codes", "irc", "validation", "permit-by-rule"],
    "resources": [
      {
        "url": "https://api.openpermit.org/knowledge-packs/IRC2021",
        "format": "JSON-LD",
        "name": "IRC2021 Knowledge Pack"
      }
    ]
  }
}
```

**Benefits:**
- Public transparency on code enforcement logic
- Reusable across jurisdictions
- Community contributions and improvements
- Federal open data compliance

## Contributing Rules

### 1. Identify Objective Requirements

**Good candidates for automation:**
- âœ… Dimensional requirements (e.g., "not less than 7 feet")
- âœ… Spacing limits (e.g., "not more than 16 inches on center")
- âœ… Quantity requirements (e.g., "one smoke detector per bedroom")
- âœ… Prescriptive tables (e.g., joist span tables)

**Poor candidates (require human judgment):**
- âŒ "Adequate structural capacity" (without specific values)
- âŒ "Reasonable access" (subjective)
- âŒ Performance-based criteria (requires engineering calculation)

### 2. Write Deterministic Rule

```python
def check_[code_section](ifc_element: Dict[str, Any]) -> ValidationResult:
    """
    [Code Reference] - [Brief description]

    [Full code text in quotes]
    """
    # 1. Check applicability
    if not [condition]:
        return ValidationResult(result="not_applicable", ...)

    # 2. Extract measured values
    measured = ifc_element.get("[property]")

    # 3. Apply deterministic check
    if measured [operator] [threshold]:
        return ValidationResult(result="pass", ...)
    else:
        return ValidationResult(result="fail", ...)
```

### 3. Add Test Cases

Include in `pack.json`:

```json
"testCases": [
  {
    "name": "Compliant case",
    "input": {...},
    "expectedResult": "pass"
  },
  {
    "name": "Non-compliant case",
    "input": {...},
    "expectedResult": "fail"
  },
  {
    "name": "Not applicable case",
    "input": {...},
    "expectedResult": "not_applicable"
  }
]
```

### 4. Submit Pull Request

1. Fork repository
2. Add rule to appropriate knowledge pack
3. Run tests: `pytest knowledge-packs/`
4. Submit PR with:
   - Rule code
   - pack.json update
   - Test cases
   - Code section reference

## Testing

**Run all knowledge pack tests:**

```bash
pytest knowledge-packs/
```

**Test specific pack:**

```bash
pytest knowledge-packs/IRC2021/
```

**Test specific rule:**

```bash
python knowledge-packs/IRC2021/irc_r602_framing.py
```

## Versioning

Knowledge packs follow **semantic versioning**:

- **Major (x.0.0)** â€” Code edition change (IRC 2021 â†’ IRC 2024)
- **Minor (1.x.0)** â€” New rules added (backward compatible)
- **Patch (1.0.x)** â€” Bug fixes, clarifications (no new rules)

**Each permit application logs the pack version used:**

```json
{
  "codeValidation": {
    "irc2021": {
      "status": "pass",
      "packVersion": "1.2.0",
      "validator": "OpenPermit v1.0.0",
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }
}
```

## Certification

Knowledge packs can be **certified by third parties** (like structural engineering software):

```json
{
  "certifications": [
    {
      "certifier": "ICC Evaluation Service",
      "certificationId": "ESR-12345",
      "scope": "IRC 2021 Prescriptive Residential",
      "validUntil": "2025-12-31"
    }
  ]
}
```

Jurisdictions can require certified knowledge packs for automated validation.

## License

All OpenPermit knowledge packs are **MIT licensed** â€” free to use, modify, and redistribute.

Jurisdictions can fork packs and add proprietary amendments if needed (though open source is encouraged).

## References

- [OpenPermit Unified API Catalog](../specs/unified-api-catalog.yaml)
- [IFC 4x3 Specification](https://technical.buildingsmart.org/standards/ifc/)
- [IRC 2021 (International Code Council)](https://codes.iccsafe.org/)
- [Permit By Rule Concept](../public/permit-by-rule.md)

---

**Key Insight:**

> **"Rules as code, not code as rules."**

We don't train AI to interpret building codes. We encode objective requirements as deterministic functions â€” **transparent, testable, and trusted**.

This is how permit-by-rule works.
